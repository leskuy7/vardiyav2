# Vardiya v2 â€” Kod Ä°nceleme Raporu

TÃ¼m backend (NestJS + Prisma) ve frontend (Next.js + Mantine + React Query) kaynak kodlarÄ± detaylÄ± incelendi. Bulgular aÅŸaÄŸÄ±da Ã¶ncelik sÄ±rasÄ±na gÃ¶re gruplanmÄ±ÅŸtÄ±r.

---

## ğŸ”´ Kritik â€” GÃ¼venlik & Veri BÃ¼tÃ¼nlÃ¼ÄŸÃ¼

### 1. [register](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.controller.ts#20-31) endpoint'i herkese aÃ§Ä±k
[auth.controller.ts](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.controller.ts#L19-L30) â€” Herhangi bir [Guard](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/common/auth/csrf.guard.ts#4-34) kullanÄ±lmÄ±yor. Herhangi biri `POST /api/auth/register` ile hesap oluÅŸturabilir.

**Ã–neri:** Register'Ä± sadece `ADMIN` rolÃ¼ne aÃ§Ä±n veya "davetiye kodu" mekanizmasÄ± ekleyin. Aksi halde kÃ¶tÃ¼ niyetli kiÅŸiler sistem iÃ§inde Ã§ok sayÄ±da sahte hesap oluÅŸturabilir.

---

### 2. KayÄ±t sonrasÄ± [Employee](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/hooks/use-employees.ts#14-23) kaydÄ± oluÅŸturulmuyor
[auth.service.ts:33-47](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.service.ts#L33-L47) â€” [register()](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.controller.ts#20-31) yalnÄ±zca [User](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/hooks/use-auth.ts#6-12) kaydÄ± oluÅŸturuyor ama iliÅŸkili bir [Employee](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/hooks/use-employees.ts#14-23) kaydÄ± yaratmÄ±yor. Bu durumda giriÅŸ yapan kullanÄ±cÄ±nÄ±n JWT payload'Ä±nda `employeeId` her zaman `undefined` olur ve vardiya/mÃ¼saitlik/rapor gibi tÃ¼m iÅŸlemler `ForbiddenException` ile Ã§Ã¶ker.

**Ã–neri:** [register()](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.controller.ts#20-31) iÃ§inde bir transaction ile hem [User](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/hooks/use-auth.ts#6-12) hem [Employee](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/hooks/use-employees.ts#14-23) kaydÄ± oluÅŸturun (tÄ±pkÄ± [employees.service.ts:44-65](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/employees/employees.service.ts#L44-L65)'deki gibi).

---

### 3. [me](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.controller.ts#82-86) endpoint'inde `name` alanÄ± dÃ¶ndÃ¼rÃ¼lmÃ¼yor
[auth.service.ts:108-120](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.service.ts#L108-L120) â€” [me()](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.controller.ts#82-86) metodu `name` alanÄ±nÄ± atlamÄ±ÅŸ. Login response'unda `name` var ama `/auth/me` ile yeni token aldÄ±ktan sonra kullanÄ±cÄ±nÄ±n adÄ± kaybolur.

```diff
 return {
   id: user.id,
   email: user.email,
+  name: user.name,
   role: user.role,
   employee: user.employee
 };
```

---

### 4. Audit log hatasÄ± sessizce yutulluyor
[audit.service.ts:27-29](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/common/audit.service.ts#L27-L29) â€” `catch {}` bloÄŸu hatalarÄ± tamamen yok sayÄ±yor. Disk dolu, DB baÄŸlantÄ±sÄ± kopuk gibi durumlarda veri kaybÄ± olur ve hiÃ§bir uyarÄ± gÃ¶sterilmez.

**Ã–neri:** En azÄ±ndan `Logger.error()` ile loglanmalÄ±:
```typescript
} catch (error) {
  this.logger.error('Audit log write failed', error);
}
```

---

### 5. [HttpExceptionFilter](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/common/http-exception.filter.ts#4-25) â€” 500 detay sÄ±zÄ±ntÄ±sÄ±
[http-exception.filter.ts:14-22](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/common/http-exception.filter.ts#L14-L22) â€” Beklenmeyen (non-HttpException) hatalar iÃ§in `details: payload` alanÄ±nda boÅŸ obje gÃ¶nderiliyor, bu iyi. Ancak production'da `exception` objesinden stack trace veya internal bilgi sÄ±zma riski var. Production ortamÄ±nda loglayÄ±p, client'a generic mesaj dÃ¶nÃ¼n.

---

## ğŸŸ  YÃ¼ksek â€” Mimari & Kod Kalitesi

### 6. [getEmployeeScope](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/shifts.service.ts#10-34) Ã¼Ã§ yerde tekrarlanÄ±yor

AynÄ± fonksiyon birebir kopyalanmÄ±ÅŸ:
- [shifts.service.ts:10-33](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/shifts.service.ts#L10-L33)
- [schedule.service.ts:9-32](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/schedule/schedule.service.ts#L9-L32)

**Ã–neri:** Bu fonksiyonu `common/` altÄ±nda bir shared servis veya utility olarak Ã§Ä±karÄ±n. Bir yerde dÃ¼zeltme yapÄ±ldÄ±ÄŸÄ±nda diÄŸerlerinde unutulabilir.

---

### 7. `ThrottlerModule` â€” `ConfigService` inject edilip kullanÄ±lmÄ±yor
[app.module.ts:18-21](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/app.module.ts#L18-L21) â€” `inject: [ConfigService]` yazÄ±lmÄ±ÅŸ ama [useFactory](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/app.module.ts#20-21) parametresinde kullanÄ±lmÄ±yor. Rate limit deÄŸerleri hard-coded.

```typescript
// Åu an:
useFactory: () => [{ ttl: 60000, limit: 120 }]
// OlmasÄ± gereken:
useFactory: (config: ConfigService) => [{
  ttl: config.get('THROTTLE_TTL', 60000),
  limit: config.get('THROTTLE_LIMIT', 120)
}]
```

---

### 8. [RolesGuard](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/common/auth/roles.guard.ts#5-29) ve [CsrfGuard](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/common/auth/csrf.guard.ts#4-34) â€” Global provider ama aslÄ±nda global guard deÄŸil
[app.module.ts:31](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/app.module.ts#L31) â€” Bu guard'lar `providers` olarak register edilmiÅŸ ama `APP_GUARD` olarak kullanÄ±lmÄ±yor. Her controller'da `@UseGuards(...)` ile manuel ekleniyor. Unutulma riski yÃ¼ksek.

**Ã–neri:** GerÃ§ekten global isteniyorsa `APP_GUARD` ile register edin. DeÄŸilse `providers` listesinden Ã§Ä±karÄ±n (ÅŸu an controller-level kullanÄ±lÄ±yor, sorun yok ama kafa karÄ±ÅŸtÄ±rÄ±cÄ±).

---

### 9. `Shift.remove()` â€” GerÃ§ek silme yerine `CANCELLED` status
[shifts.service.ts:249-253](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/shifts.service.ts#L249-L253) â€” `DELETE /shifts/:id` aslÄ±nda soft-cancel yapÄ±yor. Bu davranÄ±ÅŸ doÄŸru olabilir ama API ismi (`DELETE`) ile davranÄ±ÅŸ (`PATCH status â†’ CANCELLED`) uyumsuz. Client tarafÄ± "silindikten sonra listede gÃ¶rÃ¼nmemeli" beklentisinde olabilir.

**Ã–neri:** HTTP method'unu `PATCH` yapÄ±p mutation adÄ±nÄ± `cancelShift` olarak deÄŸiÅŸtirin; veya gerÃ§ekten hard-delete yapÄ±n.

---

### 10. [update()](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/shifts.service.ts#210-248) iÃ§in ayrÄ± DTO yok â€” [CreateShiftDto](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/dto/create-shift.dto.ts#3-21) kullanÄ±lÄ±yor
[shifts.controller.ts:59](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/shifts.controller.ts#L59) â€” Update iÅŸlemi [CreateShiftDto](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/dto/create-shift.dto.ts#3-21) kullanÄ±yor. Bu durumda update'te tÃ¼m alanlar zorunlu oluyor (partial update yapÄ±lamÄ±yor). `UpdateShiftDto` (`PartialType(CreateShiftDto)`) oluÅŸturulmalÄ±.

---

### 11. `as never` type casting'ler
BirÃ§ok yerde `as never` kullanÄ±lmÄ±ÅŸ (Ã¶r. [auth.service.ts:144](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/auth/auth.service.ts#L144), [audit.service.ts:24](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/common/audit.service.ts#L24), [shifts.service.ts:129](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/shifts.service.ts#L129)). Bu tip gÃ¼venliÄŸini tamamen devre dÄ±ÅŸÄ± bÄ±rakÄ±r ve runtime hatalara yol aÃ§abilir.

---

## ğŸŸ¡ Orta â€” VeritabanÄ± & Veri Modeli

### 12. `AvailabilityBlock.startTime/endTime` â†’ `String` tipi
[schema.prisma:78-79](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/prisma/schema.prisma#L78-L79) â€” Saat deÄŸerleri `String` olarak saklanÄ±yor (Ã¶r. `"08:30"`). GeÃ§ersiz format girildiÄŸinde DB seviyesinde kontrol yok. `@Matches(/^\d{2}:\d{2}$/)` validasyonu DTO'ya eklenebilir veya DB'de `@db.Time` tipi kullanÄ±lmasÄ± dÃ¼ÅŸÃ¼nÃ¼lebilir.

---

### 13. `AuditLog` tablosu hÄ±zla bÃ¼yÃ¼yecek â€” Retention stratejisi yok
[schema.prisma:88-97](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/prisma/schema.prisma#L88-L97) â€” Audit log tablosunda TTL/partitioning/archival yok. YÃ¼ksek trafikte tablo Ã§ok bÃ¼yÃ¼yecek.

**Ã–neri:** `createdAt` Ã¼zerinde index ekleyin ve periyodik cleanup job'Ä± planlayÄ±n.

---

### 14. `AvailabilityBlock` â€” `createdAt/updatedAt` alanlarÄ± eksik
Bu tablo, diÄŸer tÃ¼m modellerin aksine, oluÅŸturulma/gÃ¼ncellenme zamanÄ±nÄ± takip etmiyor.

---

### 15. `Employee.hourlyRate` â€” `Decimal` tipi doÄŸru, ama `Number()` ile dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor
[reports.service.ts:34](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/reports/reports.service.ts#L34) â€” `Number(shift.employee.hourlyRate ?? 0)` â†’ Prisma `Decimal` tipini `Number`'a Ã§evirmek hassasiyet kaybÄ±na neden olabilir. `toNumber()` veya `Decimal.js` ile iÅŸlem yapÄ±lmalÄ±.

---

## ğŸ”µ DÃ¼ÅŸÃ¼k-Orta â€” Frontend

### 16. Refresh token dÃ¶ngÃ¼sÃ¼ â€” sonsuz loop riski
[api.ts:34-49](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/lib/api.ts#L34-L49) â€” Refresh endpoint'i de 401 dÃ¶nerse interceptor tekrar Ã§alÄ±ÅŸÄ±r. `_retry` flag'i bunu engelliyor gibi gÃ¶rÃ¼nse de, refresh isteÄŸi `api` instance'Ä± Ã¼zerinden yapÄ±ldÄ±ÄŸÄ± iÃ§in request interceptor token ekler. Refresh baÅŸarÄ±sÄ±z olduÄŸunda kullanÄ±cÄ± login'e yÃ¶nlendirilmiyor â€” sadece hata fÄ±rlatÄ±lÄ±yor.

**Ã–neri:** Refresh baÅŸarÄ±sÄ±z olduÄŸunda [setAccessToken(null); window.location.href = '/login'](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/lib/token-store.ts#7-10) gibi bir fallback ekleyin.

---

### 17. [useShiftsActions](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/hooks/use-shifts.ts#34-65) â€” delete mutation eksik
[use-shifts.ts](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/hooks/use-shifts.ts) â€” `createShift`, `updateShift`, `acknowledgeShift` var ama `deleteShift`/`cancelShift` mutation'Ä± yok. Controller'da `DELETE` endpoint var ama frontend'den Ã§aÄŸrÄ±lmÄ±yor.

---

### 18. `QueryClient` â€” `staleTime` ve `retry` konfigÃ¼rasyonu yok
[app-provider.tsx:9](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/providers/app-provider.tsx#L9) â€” VarsayÄ±lan `QueryClient` ile `staleTime: 0` ve sÄ±nÄ±rsÄ±z retry. Bu gereksiz network trafiÄŸi ve kullanÄ±cÄ± deneyimi sorunlarÄ±na yol aÃ§ar.

```typescript
new QueryClient({
  defaultOptions: {
    queries: { staleTime: 30_000, retry: 1 },
    mutations: { retry: 0 }
  }
})
```

---

### 19. Protected layout â€” EMPLOYEE yÃ¶nlendirmesi Ã§ok agresif
[layout.tsx:23-27](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/app/(protected)/layout.tsx#L23-L27) â€” EMPLOYEE rolÃ¼ndeki kullanÄ±cÄ± `/availability` sayfasÄ±na eriÅŸebilmeli ama `pathname !== '/my-shifts'` koÅŸuluyla her seferinde `/my-shifts`'e yÃ¶nlendiriliyor.

```diff
- if (!isLoading && data?.role === 'EMPLOYEE' && pathname !== '/my-shifts') {
+ const employeeAllowed = ['/my-shifts', '/availability'];
+ if (!isLoading && data?.role === 'EMPLOYEE' && !employeeAllowed.includes(pathname)) {
```

---

### 20. Demo butonlarÄ± hepsi aynÄ± yere gidiyor
[page.tsx:68-70](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/web/src/app/page.tsx#L68-L70) â€” "Admin", "MÃ¼dÃ¼r", "Ã‡alÄ±ÅŸan" butonlarÄ±nÄ±n hepsi `/login`'e yÃ¶nlendiriyor. Auto-fill veya farklÄ± demo hesap bilgileri gÃ¶ndermeli.

---

## ğŸ”µ DÃ¼ÅŸÃ¼k â€” Ä°yileÅŸtirme Ã–nerileri

### 21. `PrismaService.enableShutdownHooks` â€” Deprecated pattern
[prisma.service.ts:10-14](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/database/prisma.service.ts#L10-L14) â€” Bu pattern Prisma v5+ iÃ§in deprecated. NestJS'in [enableShutdownHooks()](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/database/prisma.service.ts#10-15) ile yapÄ±lmalÄ± veya `OnModuleDestroy` lifecycle hook kullanÄ±lmalÄ±:

```typescript
async onModuleDestroy() {
  await this.$disconnect();
}
```

---

### 22. Test coverage Ã§ok dÃ¼ÅŸÃ¼k
Sadece 3 spec dosya var: [shifts.service.spec.ts](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/shifts.service.spec.ts), [schedule.service.spec.ts](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/schedule/schedule.service.spec.ts), [reports.service.spec.ts](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/reports/reports.service.spec.ts). Auth, availability, employees servisleri hiÃ§ test edilmemiÅŸ. E2E test yok.

---

### 23. `packages/shared` â€” BoÅŸ
Bu dizin boÅŸ. Monorepo'da paylaÅŸÄ±lan tipler (Ã¶r. DTO tipleri, enum'lar, API response tipleri) burada tanÄ±mlanabilir ve hem backend hem frontend tarafÄ±ndan kullanÄ±labilir.

---

### 24. Availability DTO'daki `_timePairGuard` alanÄ± kafa karÄ±ÅŸtÄ±rÄ±cÄ±
[create-availability.dto.ts:37-39](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/availability/dto/create-availability.dto.ts#L37-L39) â€” `@ValidateIf(...)` ile bir guard oluÅŸturulmuÅŸ ama mantÄ±ksal olarak hatalÄ±. `startTime` saÄŸlandÄ±ÄŸÄ±nda `_timePairGuard` zorunlu oluyor ki bu client'tan gÃ¶nderilecek bir alan deÄŸil. Bunun yerine servis katmanÄ±nda zaten kontrol var, bu validasyon kaldÄ±rÄ±labilir veya custom validator yazÄ±labilir.

---

### 25. `copyWeek` â€” Gece vardiyalarÄ± (date boundary) dÃ¼zgÃ¼n handle edilmiyor
[shifts.service.ts:307-311](file:///c:/Users/yksel/Desktop/yzlm/vardiyav2/apps/api/src/shifts/shifts.service.ts#L307-L311) â€” `dayOffset` hesabÄ± sadece `startTime` bazlÄ±. Gece vardiyalarÄ±nda (Ã¶r. 23:00-07:00) `endTime` bir sonraki gÃ¼ne geÃ§iyor ve `setUTCDate` yalnÄ±zca gÃ¼nÃ¼ kaydÄ±rdÄ±ÄŸÄ± iÃ§in ayÄ±n son gÃ¼nlerinde taÅŸma olabilir.

---

## Ã–zet Tablo

| Kategori | Kritik | YÃ¼ksek | Orta | DÃ¼ÅŸÃ¼k |
|---|---|---|---|---|
| GÃ¼venlik | 2 | 1 | â€” | â€” |
| Mimari / Kod Kalitesi | â€” | 6 | â€” | 3 |
| VeritabanÄ± | â€” | â€” | 4 | â€” |
| Frontend | â€” | 1 | 3 | 1 |
| **Toplam** | **2** | **8** | **7** | **4** |

---

> Bu rapor mevcut kodun analizi niteliÄŸindedir. Herhangi bir dÃ¼zeltmeye baÅŸlamadan Ã¶nce hangi maddelerin Ã¶ncelikli olduÄŸuna karar verelim.
